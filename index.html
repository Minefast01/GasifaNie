<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบจัดการงานด้วย Firebase (UI เดิม)</title>
  <!-- CSS เดิมยังคงไว้เหมือนใน code.txt -->
  <!-- กรุณาแนบ CSS เดิมของคุณตรงนี้ -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- UI เดิมคงอยู่ทั้งหมด -->
  <div id="sidebar">
    <h2>หมวดหมู่</h2>
    <ul id="category-list"></ul>
    <div id="new-category">
      <input type="text" id="category-input" placeholder="พิมพ์ชื่อหมวดหมู่..." />
      <button id="add-category-btn">เพิ่ม</button>
    </div>
  </div>

  <div id="content-wrapper">
    <div id="top-bar">
      <button id="hamburger-btn">☰</button>
      <button id="toggle-theme-btn">โหมดมืด</button>
      <button id="logout-btn">ออกจากระบบ</button>
    </div>
    <ul id="task-list"></ul>
  </div>

  <div id="input-tab">
    <input type="text" id="task-text-input" placeholder="พิมพ์งานที่ต้องการเพิ่ม..." autocomplete="off" />
    <button id="add-task-btn">เพิ่ม</button>
  </div>

  <!-- Firebase Logic แบบรวมกับ UI เดิม -->
  <script type="module">
    // Import functions from the Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB0uJoVfeo8pgeTSBnpIS0_Wn0crK77tn8",
      authDomain: "gasifanieprojectlogin.firebaseapp.com",
      projectId: "gasifanieprojectlogin",
      storageBucket: "gasifanieprojectlogin.firebasestorage.app",
      messagingSenderId: "624483665613",
      appId: "1:624483665613:web:e0bbde2d0d4d1ed8ad4b84",
      measurementId: "G-C5L44TFZ1L"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global state variables
    let currentUserUid = null;
    let selectedCategoryId = null;
    let categories = []; // Will store { id, name, userId }

    // UI Element selectors
    const categoryList = document.getElementById('category-list');
    const taskList = document.getElementById('task-list');
    const categoryInput = document.getElementById('category-input');
    const taskInput = document.getElementById('task-text-input');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addTaskBtn = document.getElementById('add-task-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUserUid = user.uid;
        loadAndRenderCategories();
      } else {
        window.location.href = 'login.html';
      }
    });

    async function handleLogout() {
      try {
        await signOut(auth);
        // onAuthStateChanged will handle the redirect
      } catch (error) {
        console.error("Error signing out: ", error);
      }
    }

    // --- CATEGORIES ---
    async function loadAndRenderCategories() {
      const q = query(collection(db, 'categories'), where('userId', '==', currentUserUid));
      const snapshot = await getDocs(q);
      
      categories = [];
      categoryList.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        categories.push({ id: docSnap.id, ...docSnap.data() });
      });

      categories.forEach(cat => {
        const li = document.createElement('li');
        li.textContent = cat.name;
        li.dataset.categoryId = cat.id;
        li.onclick = () => {
          document.querySelectorAll('#category-list li').forEach(item => item.classList.remove('selected'));
          li.classList.add('selected');
          selectedCategoryId = cat.id;
          loadAndRenderTasks();
        };
        categoryList.appendChild(li);
      });

      if (categories.length > 0) {
        categoryList.querySelector('li').click();
      } else {
        taskList.innerHTML = '<li>สร้างหมวดหมู่ใหม่เพื่อเริ่มใช้งาน</li>';
      }
    }

    async function handleAddCategory() {
      const name = categoryInput.value.trim();
      if (!name) {
        alert('กรุณาพิมพ์ชื่อหมวดหมู่');
        return;
      }
      if (categories.some(cat => cat.name === name)) {
        alert('หมวดหมู่นี้มีอยู่แล้ว');
        return;
      }
      
      await addDoc(collection(db, 'categories'), { userId: currentUserUid, name });
      categoryInput.value = '';
      await loadAndRenderCategories();
    }

    // --- TASKS ---
    async function loadAndRenderTasks() {
      if (!selectedCategoryId) return;
      const q = query(collection(db, 'tasks'), where('userId', '==', currentUserUid), where('categoryId', '==', selectedCategoryId));
      const snapshot = await getDocs(q);
      
      taskList.innerHTML = '';
      if (snapshot.empty) {
          taskList.innerHTML = '<li>ไม่มีงานในหมวดหมู่นี้</li>';
      }

      snapshot.forEach(docSnap => {
        const task = { id: docSnap.id, ...docSnap.data() };
        const li = document.createElement('li');
        li.textContent = task.text;
        
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ลบ';
        deleteButton.className = 'delete-task-btn';
        deleteButton.onclick = (e) => {
          e.stopPropagation();
          handleDeleteTask(task.id);
        };
        
        li.appendChild(deleteButton);
        taskList.appendChild(li);
      });
    }

    async function handleAddTask() {
      const text = taskInput.value.trim();
      if (!text) {
        alert('กรุณาพิมพ์ชื่องาน');
        return;
      }
      if (!selectedCategoryId) {
        alert('กรุณาเลือกหมวดหมู่ก่อน');
        return;
      }

      await addDoc(collection(db, 'tasks'), {
        userId: currentUserUid,
        categoryId: selectedCategoryId,
        text: text,
        description: '',
        images: [],
        createdAt: serverTimestamp()
      });

      taskInput.value = '';
      await loadAndRenderTasks();
    }

    async function handleDeleteTask(taskId) {
      if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?')) return;
      await deleteDoc(doc(db, 'tasks', taskId));
      await loadAndRenderTasks();
    }
    
    // This function is now available for future use
    async function handleUpdateTask(taskId, data) {
        await updateDoc(doc(db, 'tasks', taskId), data);
        await loadAndRenderTasks();
    }

    // --- EVENT LISTENERS ---
    addCategoryBtn.addEventListener('click', handleAddCategory);
    addTaskBtn.addEventListener('click', handleAddTask);
    logoutBtn.addEventListener('click', handleLogout);

    categoryInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAddCategory();
    });
    taskInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAddTask();
    });
  </script>
</body>
</html>
